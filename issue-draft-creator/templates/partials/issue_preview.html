<!-- ローディングインジケーター -->
<div id="loading-indicator" class="has-text-centered py-6 is-hidden">
    <span class="icon is-large">
        <i class="fas fa-spinner fa-pulse fa-2x"></i>
    </span>
    <p class="mt-3">Issue を生成中...</p>
</div>

<div class="box" data-issue="{{ issue.json() | safe }}">
    <h3 class="title is-5">{{ issue.title }}</h3>
    
    <div class="tabs">
        <ul>
            <li class="is-active"><a data-tab="preview">プレビュー</a></li>
            <li><a data-tab="markdown">Markdown</a></li>
        </ul>
    </div>
    
    <div id="tab-preview" class="tab-content">
        <!-- ユーザーストーリー -->
        <div class="content">
            <h4 class="title is-6">User Story</h4>
            <p>{{ issue.story }}</p>
            
            <!-- 受け入れ基準 -->
            {% if issue.criteria %}
            <h4 class="title is-6">Acceptance Criteria</h4>
            <ul>
                {% for item in issue.criteria|format_list_items %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            
            <!-- 技術要件 -->
            {% if issue.requirements %}
            <h4 class="title is-6">Technical Requirements</h4>
            <ul>
                {% for item in issue.requirements|format_list_items %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
    </div>
    
    <div id="tab-markdown" class="tab-content is-hidden">
        <pre><code>{{ issue|to_markdown }}</code></pre>
    </div>
    
    <div class="field is-grouped mt-4">
        <div class="control">
            <a href="/preview/{{ issue.id }}" class="button is-info">
                <span class="icon mr-1">
                    <i class="fas fa-edit"></i>
                </span>
                <span>詳細表示</span>
            </a>
        </div>
        <div class="control">
            <button class="button is-primary" id="copy-markdown">
                <span class="icon mr-1">
                    <i class="fas fa-copy"></i>
                </span>
                <span>Markdownをコピー</span>
            </button>
        </div>
    </div>
</div>

{% if use_local_storage %}
<script>
    // Issueをローカルストレージに保存
    const issue = {{ issue.json() | safe }};
    window.issueStorage.addIssue(issue);
</script>
{% endif %}

<script>
    // タブ切り替え
    document.querySelectorAll('[data-tab]').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // タブのアクティブ状態を切り替え
            document.querySelectorAll('[data-tab]').forEach(t => {
                t.parentElement.classList.remove('is-active');
            });
            this.parentElement.classList.add('is-active');
            
            // コンテンツの表示/非表示を切り替え
            const tabId = this.getAttribute('data-tab');
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('is-hidden');
            });
            document.getElementById(`tab-${tabId}`).classList.remove('is-hidden');
        });
    });
    
    // Markdownコピー機能
    document.getElementById('copy-markdown').addEventListener('click', function() {
        const markdown = `{{ issue|to_markdown|safe }}`;
        navigator.clipboard.writeText(markdown)
            .then(() => {
                this.classList.add('is-success');
                this.querySelector('span:last-child').textContent = 'コピーしました';
                
                setTimeout(() => {
                    this.classList.remove('is-success');
                    this.querySelector('span:last-child').textContent = 'Markdownをコピー';
                }, 2000);
            })
            .catch(err => {
                console.error('クリップボードへのコピーに失敗しました', err);
            });
    });

    // HTMXイベントハンドラ
    document.body.addEventListener('htmx:beforeRequest', function(evt) {
        if (evt.detail.target.id === 'issue-preview') {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.remove('is-hidden');
        }
    });

    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.target.id === 'issue-preview') {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.add('is-hidden');
        }
    });
</script>
