{% extends "base.html" %}

{% block content %}
<div class="columns">
    <div class="column is-8 is-offset-2">
        <h1 class="title">Create New Issue</h1>
        
        <form hx-post="/api/requests"
              hx-trigger="submit"
              hx-target="#preview-area"
              hx-swap="innerHTML"
              hx-indicator="#loading">
            
            <div class="field">
                <label class="label">Describe your issue in natural language</label>
                <div class="control">
                    <textarea name="user_input"
                             class="textarea"
                             placeholder="Enter your description here..."
                             required></textarea>
                </div>
            </div>

            <div class="field">
                <div class="control">
                    <button class="button is-primary" type="submit">
                        Generate Issue
                    </button>
                </div>
            </div>
        </form>

        <div id="loading" class="is-hidden">
            <progress class="progress is-small is-primary" max="100">15%</progress>
        </div>

        <div id="preview-area" class="mt-5"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.body.addEventListener('htmx:beforeRequest', function(evt) {
        document.getElementById('loading').classList.remove('is-hidden');
    });

    document.body.addEventListener('htmx:afterRequest', function(evt) {
        document.getElementById('loading').classList.add('is-hidden');
    });

    document.body.addEventListener('htmx:error', function(evt) {
        const errorNotification = document.getElementById('error-notification');
        const errorMessage = document.getElementById('error-message');
        errorMessage.textContent = evt.detail.error;
        errorNotification.classList.remove('is-hidden');
    });

    // 改行をHTMLの<br>タグに変換する関数
    function convertNewlinesToBr() {
        const previewArea = document.getElementById('preview-area');
        if (!previewArea) return;

        const storyElement = previewArea.querySelector('.content p');
        const criteriaElement = previewArea.querySelector('.content .notification:nth-of-type(1)');
        const requirementsElement = previewArea.querySelector('.content .notification:nth-of-type(2)');

        if (storyElement) {
            storyElement.innerHTML = storyElement.innerHTML.replace(/\n/g, '<br>');
        }
        if (criteriaElement) {
            criteriaElement.innerHTML = criteriaElement.innerHTML.replace(/\n/g, '<br>');
        }
        if (requirementsElement) {
            requirementsElement.innerHTML = requirementsElement.innerHTML.replace(/\n/g, '<br>');
        }
    }

    // レスポンス受信後に改行変換を実行
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'preview-area') {
            convertNewlinesToBr();
        }
    });
</script>
{% endblock %}