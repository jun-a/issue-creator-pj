{% extends "base.html" %}

{% block content %}
<div class="columns">
    <div class="column is-10 is-offset-1">
        <h1 class="title">Issue History</h1>

        <div class="box"
             hx-get="/history/data"
             hx-trigger="load"
             hx-target="#issues-list"
             hx-indicator="#loading">
            
            <div id="loading" class="is-hidden">
                <progress class="progress is-small is-primary" max="100">15%</progress>
            </div>

            <div id="issues-list">
                {% if issues %}
                <table class="table is-fullwidth">
                    <thead>
                        <tr>
                            <th>Created</th>
                            <th>Title</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for issue in issues %}
                        <tr>
                            <td>{{ issue.created_at }}</td>
                            <td>{{ issue.title }}</td>
                            <td>
                                <div class="buttons">
                                    <a href="/preview/{{ issue.id }}"
                                       class="button is-small is-info">
                                        View
                                    </a>
                                    <button class="button is-small is-danger"
                                            hx-delete="/api/issues/{{ issue.id }}"
                                            hx-confirm="Are you sure you want to delete this issue?"
                                            hx-target="closest tr"
                                            hx-swap="outerHTML">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="notification">
                    No issues found. <a href="/">Create your first issue</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.body.addEventListener('htmx:error', function(evt) {
        const errorNotification = document.getElementById('error-notification');
        const errorMessage = document.getElementById('error-message');
        errorMessage.textContent = evt.detail.error;
        errorNotification.classList.remove('is-hidden');
    });
</script>
{% endblock %}